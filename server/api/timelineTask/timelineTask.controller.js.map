{"version":3,"sources":["../../../../server/api/timelineTask/timelineTask.controller.js"],"names":["index","show","create","createNewTimeline","updateTimeline","copyToTimelines","deleteTimeline","getAllTimelines","copyMasterTL","update","destroy","TimelineTask","model","DeletedTLTask","Timeline","MasterTasksCtrl","require","dateUtil","Utils","RoomTimelineCtrl","SiteCtrl","moment","Q","async","CronJob","reoccurringGenerator","clearRecentlyDeleted","on","err","console","log","masterPeriods","periodLength","percent","respondWithResult","res","statusCode","entity","status","json","saveUpdates","updates","updated","extend","save","then","removeEntity","remove","end","handleEntityNotFound","handleError","send","req","find","exec","catch","exports","timelineQuery","query","body","recentlyDeleted","requestTime","headers","requesttime","referer","builtQuery","queryBuilder","appversion","lean","tlTasks","queryObj","appVersion","newVersion","incluldeNonGrows","dailyCheckDay","today","taskFilter","queryFilters","haveFilters","TTFilters","clarityFilter","dateFilter","queryModel","findTTFilters","findClarityFilter","findDateFilter","yesterday","subtract","requestHour","Date","getHours","compareVersions","parseQuery","taskTypeArr","cloneDeep","taskType","dateF","dateFilterDays","filterDaysAgo","hasDateFilterDays","length","occurrenceDate","weekBack","daysAgo","isMaster","taskTLTemplateQuery","taskTLTemplate","and","$in","checkTemplateObjQuery","checkTemplateObj","$eq","$or","room","site","hideRooms","$nin","dailyCheckIdx","indexOf","splice","or","$and","$gte","toDate","xCheckIdx","tunnelTL","ttQuery","updatedTTQuery","hasTTDate","TLFromDate","TLToDate","pull","$lte","ttOr","map","f","push","hasAdmin","includes","adminAnd","$ne","getQuery","hasProblem","completed","notNeeded","isArray","populateVersion","populate","filters","filtersCopy","filter","queryType","parsedQuery","item","key","findFieldValues","field","hasOwnProperty","o","property","newReoccurringTask","newTaskObj","response","generateNewReoccurringTask","task","genDate","standardizeDate","filterOutTasks","taskToGenerate","generateTasks","generated","bulkUpdate","taskIds","updateObj","multi","tasks","bulkTaskDelete","deletePromises","findById","taskId","all","resp","restoreTask","params","id","restoredTask","toObject","deletedDate","__t","siteId","_id","restoreReoccurringTask","timelineObj","timelineName","timelineMainColor","timelineSubColor","copyToIds","taskToCopy","_v","promises","tlId","newCopy","childTasks","buildParentTask","results","timelines","getTimelineTaskCount","taskCount","copyToTL","inPeriod","masterTasks","test","take","mTask","mCopy","newMaster","isNew","deferred","defer","timelineIds","t","where","in","select","reject","returnCounts","tl","equals","tlCountObj","assign","resolve","promise","roomDetails","masterTask","checkTLDates","startDate","sameDateCount","taskDate","forCycleStarting","isSame","pickTaskDetails","getAllReoccurringTasks","sites","forEach","genSiteTasks","reoccurringTasks","waterfall","apply","updateTemplateTasks","deleted","d","diff","Math","abs","reoccurringTest","testInfo","getReoccurringTasks","callback","filteredTasks","newTask","taskLastBuilt","taskRepeatPreset","day","taskRepeatCustom","taskRepeatDays","newGenTaskPromises","pick","isChildTask","newTasks","templateTasks","newParentTask","taskTemplate","retrieveChildren","buildChildren","saveChildrenToParent","childIds","children","parentTask","childrenTasks","childPromises","childTaskTemplate","childIndex","child","childTaskIds","allTasks","taskTemplateIds","standardDate","$set","new","buildRoomTasks","tlDetails","flippedTBD","TBDTaskCount","reoccuringTaskCount","tlDates","roomLengths","findLengths","flippedDate","endDate","isStandardVegLength","vegLength","isStandardFlowerLength","buildTimelineTasks","tlTasksPromises","occurrenceObj","type","buildTask","flowerLength","reoccurringTaskCount","buildCycleTasks","fromDate","tasksPromises","buildCycleTask","roomGeneratedField","generateTasksFromTimeline","tlTemplateId","fromDateType","tasksToGen","buildCycleTaskFromTemplate","buildErrors","genError","taskPromises","newTaskInfo","templateTask","builtTask","newTaskGenerationEvent","generatedDate","fromTLTemplateId","taskGenerationEvents","markModified","returnData","generatedTasks","findDayWeekPeriodFromDate","roomStart","roomFlipped","add","taskDay","dayAndWeek","findDayAndWeek","taskWeek","week","isStandardVeg","isStandardFlower","occurrenceDay","title","backgroundColor","warningColor","timeEstimate","notes","priority","subPriority","saveToSite","templateId","masterCheckLocation","saveToRoomTBD","isStandardPeriod","calculateDayFromMasterPercent","value","findTaskDate","shouldImportToSite","findByIdAndUpdate","$push","TBDTasks","images","fromTLTemplate","masterTaskId","e","genTitle","solution","taskTitle","occurrenceInfo","selectedTime","findTaskDateFromGeneralDate","masterDay","period","masterPeriodLength","percentThroughMasterPeriod","ceil","round","weekMultiplier","dayInPeriod","periodStartDate"],"mappings":"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","file":"timelineTask.controller.js","sourcesContent":["/**\n * Using Rails-like standard naming convention for endpoints.\n * GET     /api/timelineTasks              ->  index\n * POST    /api/timelineTasks              ->  create\n * GET     /api/timelineTasks/:id          ->  show\n * PUT     /api/timelineTasks/:id          ->  update\n * DELETE  /api/timelineTasks/:id          ->  destroy\n */\n\n'use strict';\n\nimport _ from 'lodash';\nimport mParser from 'mongo-parse';\nimport mongoose from 'mongoose';\n//import TimelineTask from './../../models/timelineTask.model';\nvar TimelineTask = mongoose.model('TimelineTask');\nvar DeletedTLTask = mongoose.model('DeletedTLTask');\nvar Timeline = mongoose.model('Timeline');\nvar MasterTasksCtrl = require('./../masterTimeline/masterTimeline.controller');\nvar dateUtil = require('./../../components/Date.Utils');\nvar Utils = require('../../components/Utils');\nvar RoomTimelineCtrl = require('./../roomTimeline/roomTimeline.controller');\nvar SiteCtrl = require('./../site/site.controller');\nimport Room from './../../models/room.model';\nvar moment = require('moment');\nvar Q = require('q');\nvar async = require('async');\nvar CronJob = require('cron').CronJob;\n\n//new CronJob('10 * * * * 0-6', function() {\n//  var today = moment().startOf('day')\n//  console.log('today: ', today);\n//  console.log('Test Time!');\n//}, null, true, null);\n\nnew CronJob('00 00 4 * * 0-6', function() {\n  reoccurringGenerator()\n  clearRecentlyDeleted()\n}, null, true, 'America/Los_Angeles');\n\nTimelineTask.on('index', function(err) {\n  if(err) {\n    console.log('index err', err);\n  } else {\n    console.log('inexed fine!');\n  }\n})\n\nvar masterPeriods = {\n  'veg' : {\n    periodLength : 21,\n    percent : 21/77\n  },\n  'flower' : {\n    periodLength : 56,\n    percent : 56/77\n  }\n}\n\nfunction respondWithResult(res, statusCode) {\n  statusCode = statusCode || 200;\n  return function(entity) {\n    if (entity) {\n      res.status(statusCode).json(entity);\n    }\n  };\n}\n\nfunction saveUpdates(updates) {\n  return function(entity) {\n    var updated = _.extend(entity, updates);\n    return updated.save()\n      .then(updated => {\n        return updated;\n      });\n  };\n}\n\nfunction removeEntity(res) {\n  return function(entity) {\n    if (entity) {\n      return entity.remove()\n        .then(() => {\n          res.status(204).end();\n        });\n    }\n  };\n}\n\nfunction handleEntityNotFound(res) {\n  return function(entity) {\n    if (!entity) {\n      res.status(404).end();\n      return null;\n    }\n    return entity;\n  };\n}\n\nfunction handleError(res, statusCode) {\n  statusCode = statusCode || 500;\n  return function(err) {\n    res.status(statusCode).send(err);\n  };\n}\n\n// Gets a list of TimelineTasks\nexport function index(req, res) {\n  return TimelineTask.find().exec()\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\nexports.timelineQuery = function(req, res) {\n  var query = req.body;\n  var recentlyDeleted = query.recentlyDeleted;\n  var requestTime = req.headers.requesttime;\n  var referer = req.headers.referer;\n  var builtQuery = queryBuilder(query, req.headers.appversion, requestTime, recentlyDeleted);\n  builtQuery.lean().exec(function(err, tlTasks) {\n    if(err) return res.status(400).json(err);\n    else {\n      return res.status(200).json(tlTasks)\n    }\n  })\n}\n\nfunction queryBuilder(queryObj, appVersion, requestTime, recentlyDeleted) {\n  var newVersion = false,\n    incluldeNonGrows = false;\n  var dailyCheckDay;\n  var today = moment();\n  var taskFilter,\n    queryFilters,\n    haveFilters = false,\n    TTFilters,\n    clarityFilter,\n    dateFilter;\n  var query;\n  var queryModel = TimelineTask;\n\n  if(recentlyDeleted) {\n    queryModel = DeletedTLTask;\n  }\n  if(queryObj.taskFilter) {\n    taskFilter = queryObj.taskFilter;\n  }\n  if(queryObj.queryFilters) {\n    queryFilters = queryObj.queryFilters;\n    haveFilters = true;\n    TTFilters = findTTFilters(queryFilters);\n    clarityFilter = findClarityFilter(queryFilters);\n    dateFilter = findDateFilter(queryFilters);\n  }\n  var yesterday = moment(today).subtract(1, 'days');\n  if(requestTime) {\n    var requestHour = new Date(requestTime).getHours();\n  } else {\n    dailyCheckDay = yesterday;\n  }\n  var compareVersions = Utils.compareVersions(appVersion, \"0.1.0\");\n  if(compareVersions >= 0) {\n    newVersion = true;\n  }\n\n  queryObj = parseQuery(queryObj);\n  var taskTypeArr = _.cloneDeep(queryObj.taskType);\n  console.log('task types', taskTypeArr);\n\n  var dateF,\n    dateFilterDays,\n    filterDaysAgo,\n    hasDateFilterDays = false;\n\n  if(dateFilter && dateFilter.length > 0) {\n    dateF = dateFilter[0];\n    if(dateF && dateF.queryObj) {\n      dateFilterDays = dateF.queryObj.occurrenceDate,\n        filterDaysAgo = moment(today).subtract(dateFilterDays, 'days');\n\n      hasDateFilterDays = true;\n    }\n  }\n  var weekBack = moment(today).subtract(7, 'days');\n  var daysAgo = moment(today).subtract(80, 'days');\n  if(queryObj.isMaster) {\n    var taskTLTemplateQuery = {};\n    if(queryObj.taskTLTemplate) {\n      taskTLTemplateQuery = {\n        taskTLTemplate : queryObj.taskTLTemplate\n      }\n    } else {\n      taskTLTemplateQuery = {\n        taskTLTemplate : null\n      }\n    }\n    query = queryModel\n            .find()\n            .and([\n              {isMaster : true},\n              {taskType : {$in : queryObj.taskType}},\n              {taskTLTemplate : queryObj.taskTLTemplate}\n            ])\n  } else {\n    var checkTemplateObjQuery;\n    if(queryObj.checkTemplateObj) {\n      checkTemplateObjQuery = {$eq : true}\n    } else {\n      checkTemplateObjQuery = {$in : [null, false]}\n    }\n\n    query = queryModel\n      .find()\n      .and([\n        {$or : [\n          {room : {$in : queryObj.room}},\n          {site : {$in : queryObj.site}}\n        ]},\n        {isMaster : false},\n        {checkTemplateObj : checkTemplateObjQuery}\n      ])\n\n\n    if(queryObj.hideRooms && queryObj.hideRooms.length) {\n      query.and([{room : {$nin : queryObj.hideRooms}}])\n    }\n\n    if(!queryObj.checkTemplateObj) {\n      var dailyCheckIdx = queryObj.taskType.indexOf('daily-check');\n      if(dailyCheckIdx > -1) {\n        queryObj.taskType.splice(dailyCheckIdx,1);\n        console.log('length', taskTypeArr.length);\n        if(taskTypeArr.length === 1 && hasDateFilterDays) {\n          query.or([\n            {$and : [\n              {taskType : 'daily-check'},\n              {occurrenceDate : {$gte :filterDaysAgo.toDate()} }\n            ]}\n          ])\n        } else {\n          query.or([\n            {$and : [\n              {taskType : 'daily-check'},\n              {occurrenceDate : {$gte : yesterday.toDate()} }\n            ]}\n          ])\n        }\n\n      }\n      var xCheckIdx = queryObj.taskType.indexOf('x-check');\n      if(xCheckIdx > -1) {\n        queryObj.taskType.splice(xCheckIdx,1);\n        if(taskTypeArr.length === 1 && hasDateFilterDays) {\n          query.or([\n            {$and : [\n              {taskType : 'x-check'},\n              {occurrenceDate : {$gte : filterDaysAgo.toDate()} }\n            ]}\n          ])\n        } else {\n          query.or([\n            {$and : [\n              {taskType : 'x-check'},\n              {occurrenceDate : {$gte : weekBack.toDate()} }\n            ]}\n          ])\n        }\n      }\n\n\n      var tunnelTL = queryObj.taskType.indexOf('tunnel-timeline');\n      if(tunnelTL > -1) {\n        var ttQuery,\n          updatedTTQuery = false,\n          hasTTDate = false;\n        if(queryObj.TLFromDate && queryObj.TLToDate) {\n          updatedTTQuery = true;\n          hasTTDate = true;\n          _.pull(queryObj.taskType, 'tunnel-timeline');\n          ttQuery = [\n            {$and : [\n                {taskType : 'tunnel-timeline'},\n                {occurrenceDate : {\n                    $gte : queryObj.TLFromDate,\n                    $lte : queryObj.TLToDate\n                  }}\n              ]\n            }\n          ]\n        }\n\n        if(haveFilters) {\n          _.pull(queryObj.taskType, 'tunnel-timeline');\n        }\n        if(TTFilters) {\n          var ttOr = _.map(TTFilters, function(f) {\n            return f.queryObj;\n          })\n          if(ttOr && ttOr.length > 0) {\n            updatedTTQuery = true;\n            if(!ttQuery) {\n              ttQuery = [\n                { $and : [\n                    {taskType : 'tunnel-timeline'},\n                    {$or : ttOr}\n                  ]\n                }\n              ]\n            } else {\n              ttQuery[0]['$and'].push({\n                $or : ttOr\n              })\n            }\n          }\n        }\n\n        if(updatedTTQuery) {\n          if(hasDateFilterDays) {\n            if(!hasTTDate) {\n              ttQuery[0]['$and'].push({occurrenceDate : {$gte : filterDaysAgo.toDate()} })\n            }\n          }\n\n          query.or(ttQuery)\n        }\n      }\n      query.or({taskType : {$in : queryObj.taskType}});\n\n      if(newVersion) {\n        var hasAdmin = _.includes(queryObj.taskType, 'admin-assigned');\n        if(hasAdmin) {\n          var adminAnd = [\n            {taskType : 'admin-assigned'},\n            {isMaster : {$ne : true}}\n          ]\n\n          if(queryObj.site && queryObj.site.length) {\n            adminAnd.push({$or : [\n              {site : {$in: queryObj.site}},\n              {site : {$eq : null}}\n            ]})\n          } else {\n            adminAnd.push({site : {$eq : null}})\n          }\n          query = queryModel\n            .find()\n            .or([\n              {'$and' : adminAnd},\n              query.getQuery()\n            ])\n\n          //if(taskFilter) {\n          //  console.log('add Task filter');\n          //  if(taskFilter == 'ohShit') {\n          //    query.and([{hasProblem : {$eq : true}}])\n          //  }\n          //}\n        } else {\n\n        }\n      }\n    } else {\n      query.and([{taskType : {$in : queryObj.taskType}}])\n    }\n\n    if(taskFilter) {\n      if(taskFilter === 'ohShit') {\n        query.and([{hasProblem : {$eq : true}}])\n      } else if(taskFilter === 'hideDone') {\n        query.and([\n          {completed : {$ne : true}},\n          {notNeeded : {$ne : true}}\n        ])\n      }\n    }\n\n    if(clarityFilter) {\n      _.map(clarityFilter, function(f) {\n        var queryObj = f.queryObj;\n        if(!queryObj) return;\n\n        if(_.isArray(queryObj)) {\n          query.and(queryObj)\n        } else {\n          query.and([queryObj])\n        }\n      })\n\n    }\n\n  }\n\n\n  //var queryParams = query['$and'];\n  //console.log('params: ', queryParams);\n  //var hasAdmin = false;\n  //var taskTypeQuery = _.find(queryParams, (item) => _.has(item,'taskType'));\n  //var isMasterObj = _.find(queryParams, (item) => _.has(item,'isMaster'));\n  //var isMaster = isMasterObj['isMaster'];\n  //if(taskTypeQuery.hasOwnProperty('taskType')) {\n  //  var taskTypes = taskTypeQuery['taskType'];\n  //  hasAdmin = _.indexOf(taskTypes['$in'],'admin-assigned');\n  //  if(hasAdmin > -1) {\n  //    query = {\n  //      '$or' : [\n  //        {'$and' : [\n  //          {taskType : 'admin-assigned'},\n  //          {isMaster : isMaster},\n  //\n  //        ]},\n  //        {'$and' : query['$and']}\n  //      ]\n  //    }\n  //  }\n  //}\n  //query.populate('site room');\n\n  var populateVersion = Utils.compareVersions(appVersion, \"1.0.2\");\n  if(populateVersion < 0) {\n    console.log('app version', appVersion);\n    query.populate('site room parentTask childTasks');\n  } else {\n    query.populate('parentTask childTasks')\n  }\n\n  return query;\n}\n\nfunction findTTFilters(filters) {\n  var filtersCopy = _.cloneDeep(filters);\n  return _.filter(filtersCopy, function(f) {\n    return f.taskType === 'tunnel-timeline';\n  });\n}\n\nfunction findClarityFilter(filters) {\n  var filtersCopy = _.cloneDeep(filters);\n  return _.remove(filtersCopy, function(f) {\n    return f.clarityFilter;\n  })\n}\n\nfunction findDateFilter(filters) {\n  var filtersCopy = _.cloneDeep(filters);\n  return _.remove(filtersCopy, function (f) {\n    return f.queryType === 'date'\n  })\n}\n\nfunction parseQuery(query) {\n  var parsedQuery = {};\n  _.map(query['$and'], function(item,key) {\n    return findFieldValues(item,parsedQuery);\n  })\n  return parsedQuery;\n}\n\nfunction findFieldValues(item, parsedQuery) {\n  for(var field in item) {\n    if(item.hasOwnProperty(field)) {\n      if(field === 'isMaster') {\n        parsedQuery['isMaster'] = item[field];\n        break;\n      }\n      if(field === 'taskType') {\n        parsedQuery['taskType'] = item[field]['$in']\n        break;\n      }\n      if(field === 'taskTLTemplate') {\n        parsedQuery['taskTLTemplate'] = item[field]\n        break;\n      }\n      if(field === 'TLFromDate') {\n        parsedQuery['TLFromDate'] = item[field];\n        break;\n      }\n      if(field === 'TLToDate') {\n        parsedQuery['TLToDate'] = item[field];\n        break;\n      }\n\n      if(field === '$or' || field === '$and') {\n        findFieldValues(item[field], parsedQuery);\n      } else {\n        _.map(item,(o) => {\n          for(var property in o) {\n            if(o.hasOwnProperty(property)) {\n              if(property === 'room' || property === 'site') {\n                if(o[property]['$in']) {\n                  parsedQuery[property] = o[property]['$in'];\n                  break;\n                }\n              } else if(property === 'checkTemplateObj') {\n                parsedQuery['checkTemplateObj'] = o[property]['$eq'];\n                break;\n              } else if(property === '$nin') {\n                if(field === 'room') {\n                  parsedQuery['hideRooms'] = o[property];\n                  break;\n                }\n              }\n            }\n          }\n        })\n      }\n    }\n  }\n}\n\nexports.newReoccurringTask = function(req, res) {\n  var newTaskObj = new TimelineTask(req.body)\n  newTaskObj.save(function(err) {\n    if(err) return res.status(400).json(err);\n    else {\n      SiteCtrl.newReoccurringTask(newTaskObj)\n        .then(function(response) {\n          TimelineTask.populate(newTaskObj, 'site room', function(err) {\n            generateNewReoccurringTask(newTaskObj)\n            return res.status(200).json(newTaskObj);\n          })\n\n        })\n        .catch(function(err) {\n          return res.status(400).json(err);\n        })\n    }\n  })\n}\n\nfunction generateNewReoccurringTask(task) {\n  var genDate = moment(dateUtil.standardizeDate(new Date()));\n  filterOutTasks(genDate,[task], function(err, taskToGenerate) {\n    if(!err && taskToGenerate.length) {\n      generateTasks(genDate,taskToGenerate, function(err, generated) {\n        console.log('generated: ', generated);\n      })\n    }\n  })\n}\n\n\nexports.bulkUpdate = function(req, res) {\n  TimelineTask.update({\"_id\" : {'$in' : req.body.taskIds}},\n    req.body.updateObj,\n    {multi : true},\n    function(err, tasks) {\n      if(err) return res.status(400).json(err);\n      else return res.status(200).json(tasks);\n    })\n}\n\nexports.bulkTaskDelete = function(req, res) {\n  var taskIds = req.body;\n  var deletePromises = taskIds.map(taskId => {\n    TimelineTask.findById(taskId, function(err, task) {\n      return task.remove();\n    })\n  })\n\n  Q.all(deletePromises)\n    .then(function(resp) {\n      return res.status(200).json(resp);\n    })\n    .catch(function(err) {\n      return res.status(400).json(err);\n    })\n}\n\nexports.restoreTask = function(req, res) {\n  var taskId = req.params.id;\n  DeletedTLTask.findById(taskId)\n    .exec(function(err, task) {\n      if(err) return res.status(400).json(err);\n      else if(!task) return res.status(400).json({});\n      else {\n        var restoredTask = new TimelineTask(task.toObject());\n        delete restoredTask.deletedDate;\n        restoredTask.__t = 'TimelineTask';\n        restoredTask.save(function(err) {\n          if(!err) {\n            var siteId;\n            if(restoredTask.site && !restoredTask.site._id) {\n              siteId = restoredTask.site;\n            } else if(restoredTask.site) {\n              siteId = restoredTask.site._id;\n            }\n            if(restoredTask.checkTemplateObj && !restoredTask.isMaster) {\n              SiteCtrl.restoreReoccurringTask(restoredTask._id, siteId)\n            }\n          }\n        });\n        task.remove(function(err) {\n          console.log('err', err);\n          if(err) return res.status(400).json(err);\n          else return res.status(200).json(restoredTask);\n        })\n      }\n    })\n}\n\n// Gets a single TimelineTask from the DB\nexport function show(req, res) {\n  return TimelineTask.findById(req.params.id).populate('site room childTasks parentTask').exec()\n    .then(handleEntityNotFound(res))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Creates a new TimelineTask in the DB\nexport function create(req, res) {\n  var task = req.body;\n  var newTaskObj = new TimelineTask(task);\n  newTaskObj.save(err => {\n    if(err) return res.status(400).json(err);\n    else {\n      TimelineTask.populate(newTaskObj, 'site room', function(err) {\n        return res.status(200).json(newTaskObj);\n      })\n    }\n  })\n}\n\nexport function createNewTimeline(req, res) {\n  var timelineObj = new Timeline({\n    timelineName : req.body.timelineName,\n    timelineMainColor : req.body.timelineMainColor,\n    timelineSubColor : req.body.timelineSubColor,\n    tasks : []\n  });\n  timelineObj.save(err => {\n    if(err) return res.status(400).json(err);\n    else {\n      return res.status(200).json(timelineObj);\n    }\n  })\n}\n\nexport function updateTimeline(req, res) {\n  if (req.body._id) {\n    delete req.body._id;\n  }\n  return Timeline.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(saveUpdates(req.body))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\nexport function copyToTimelines(req, res) {\n  var copyToIds = req.body.copyToIds;\n  var taskToCopy = req.body.taskToCopy;\n  delete  taskToCopy._id;\n  delete taskToCopy._v;\n  delete  taskToCopy.occurrenceDate;\n  var promises = _.map(copyToIds, function(tlId) {\n    var newCopy = new TimelineTask(taskToCopy);\n    newCopy.taskTLTemplate = tlId;\n    if(taskToCopy.childTasks && taskToCopy.childTasks.length) {\n      return buildParentTask(newCopy, taskToCopy)\n    } else {\n      return newCopy.save()\n    }\n  })\n\n  Q.all(promises)\n    .then(function(results) {\n      return res.status(200).json(results);\n    })\n    .catch(function(err) {\n      return res.status(400).json(err);\n    })\n}\n\nexport function deleteTimeline(req, res) {\n  return Timeline.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(removeEntity(res))\n    .catch(handleError(res));\n}\n\n// 280ms -> 1.7Kb\nexport function getAllTimelines(req, res) {\n  Timeline.find()\n    .exec(function(err, timelines) {\n      if(err) return res.status(400).json(err);\n      else {\n        getTimelineTaskCount(timelines)\n          .then(function(taskCount) {\n            return res.status(200).json(taskCount);\n          })\n          .catch(function(err) {\n            return res.status(400).json(err);\n          })\n      }\n    })\n}\n\nexport function copyMasterTL(req, res) {\n  var copyToTL = req.body.copyToTL;\n  var inPeriod = req.body.inPeriod;\n  TimelineTask.find(\n    {isMaster : true, taskType: 'tunnel-timeline' , inPeriod : inPeriod, taskTLTemplate : null}\n  )\n    .lean()\n    .exec(function(err, masterTasks) {\n      if(err) return res.status(400).json(err);\n      else {\n        if(masterTasks && masterTasks.length) {\n          var test = _.take(masterTasks, 4);\n          var promises = _.map(masterTasks, function(mTask) {\n            var mCopy = _.cloneDeep(mTask);\n            delete mCopy._id;\n            delete mCopy._v;\n            delete mCopy.occurrenceDate;\n            var newMaster = new TimelineTask(mCopy);\n            newMaster.isNew = true;\n            newMaster.taskTLTemplate = copyToTL;\n            return newMaster.save()\n          })\n\n          Q.all(promises)\n            .then(function(results) {\n              return res.status(200).json(results);\n            })\n            .catch(function(err) {\n              return res.status(400).json(err);\n            })\n        }\n      }\n    })\n}\n\nfunction getTimelineTaskCount(timelines) {\n  var deferred = Q.defer();\n  var timelineIds = _.map(timelines, function(t) {return t._id});\n  TimelineTask.find({isMaster : true})\n    .where('taskTLTemplate').in(timelineIds)\n    .select('taskTLTemplate')\n    .lean(true)\n    .exec(function(err, tasks) {\n      if(err) deferred.reject(err);\n      else {\n        var returnCounts = _.map(timelines, function(tl) {\n          var taskCount = _.filter(tasks, function(task) {\n            return tl._id.equals(task.taskTLTemplate);\n          }).length;\n          var tlCountObj = {\n            taskCount : taskCount\n          }\n          _.assign(tlCountObj, tl.toObject());\n          return tlCountObj\n        })\n        deferred.resolve(returnCounts);\n      }\n    })\n\n  return deferred.promise;\n}\n\n// Updates an existing TimelineTask in the DB\nexport function update(req, res) {\n  if (req.body._id) {\n    delete req.body._id;\n  }\n  if(req.body.roomDetails) {\n    delete req.body.roomDetails\n  }\n  if(req.body.masterTask){\n    delete req.body.masterTask;\n  }\n  return TimelineTask.findById(req.params.id).populate('site room parentTask childTasks').exec()\n    .then(handleEntityNotFound(res))\n    .then(saveUpdates(req.body))\n    .then(respondWithResult(res))\n    .catch(handleError(res));\n}\n\n// Deletes a TimelineTask from the DB\nexport function destroy(req, res) {\n  return TimelineTask.findById(req.params.id).exec()\n    .then(handleEntityNotFound(res))\n    .then(removeEntity(res))\n    .catch(handleError(res));\n}\n\nexports.checkTLDates = function(req, res) {\n  var startDate = moment(req.body.startDate);\n  var room = req.body.room;\n  var sameDateCount = 0;\n  TimelineTask.find({room : room})\n    .lean()\n    .exec(function(err, tasks) {\n      if(err) return res.status(200).json({});\n      else {\n        for(var t=0;t<tasks.length;t++) {\n          var taskDate = moment(dateUtil.standardizeDate(tasks[t].forCycleStarting));\n          if(taskDate.isSame(startDate)) {\n            sameDateCount++;\n          }\n        }\n        if(sameDateCount > 0) {\n          return res.status(400).json(sameDateCount);\n        } else {\n          return res.status(200).json({});\n        }\n      }\n    })\n}\n\nvar pickTaskDetails = [\n  'priority',\n  'subPriority',\n  'room',\n  'site',\n  'notes',\n  'title',\n  'taskType'\n]\n\nfunction reoccurringGenerator() {\n  var genDate = moment(dateUtil.standardizeDate(new Date()));\n  SiteCtrl.getAllReoccurringTasks(function(err, sites) {\n    _.forEach(sites, genSiteTasks)\n  })\n\n  function genSiteTasks(site){\n    var tasks = site.reoccurringTasks;\n    async.waterfall([\n      async.apply(filterOutTasks, genDate,tasks),\n      async.apply(generateTasks, genDate),\n      async.apply(updateTemplateTasks,genDate)\n    ])\n  }\n}\n\nfunction clearRecentlyDeleted() {\n  var today = moment(dateUtil.standardizeDate(new Date()));\n  DeletedTLTask.find()\n    .exec(function(err, deleted) {\n      if(deleted && deleted.length > 0) {\n        _.map(deleted, function(d) {\n          let deletedDate = moment(dateUtil.standardizeDate(d.deletedDate));\n          let diff = Math.abs(today.diff(deletedDate,'days'));\n          if(diff >= 7) {\n            d.remove()\n          }\n        })\n      }\n    })\n}\n\nexports.reoccurringTest = function(req, res) {\n  var testInfo = req.body;\n  var site = testInfo.site;\n  var startDate = moment(dateUtil.standardizeDate(testInfo.startDate));\n\n  async.waterfall([\n    async.apply(SiteCtrl.getReoccurringTasks,site),\n    async.apply(filterOutTasks, startDate),\n    async.apply(generateTasks, startDate),\n    async.apply(updateTemplateTasks,startDate)\n  ], function(err, results) {\n    if(err) return res.status(400).json(err);\n    else return res.status(200).json(results);\n  })\n}\n\n\nfunction filterOutTasks(genDate,tasks,callback) {\n  var filteredTasks = _.filter(tasks, function(task) {\n\n    var newTask = false,\n      taskDate;\n\n    if(task.taskLastBuilt) {\n      taskDate = moment(dateUtil.standardizeDate(task.taskLastBuilt));\n    } else if(!task.taskLastBuilt && task.taskType != 'daily-check') {\n      // New X-Check so check when it falls on\n      newTask = true;\n    } else {\n      // Its a new daily so generate it\n      return true;\n    }\n\n    if(!newTask) {\n      if(Math.abs(genDate.diff(taskDate,'days')) >= 1) {\n        if(task.taskType == 'daily-check'){\n          return true;\n        }\n      } else {\n        console.log('generated today');\n        // We've already built it for the day\n        return false;\n      }\n    }\n\n    if(task.taskRepeatPreset && task.taskRepeatPreset.length) {\n      if(task.taskRepeatPreset == 'weekdays') {\n        return (genDate.day() != 0 && genDate.day() != 6)\n      } else if(task.taskRepeatPreset == 'weekends') {\n        return (genDate.day() == 0 || genDate.day() == 6);\n      } else if(task.taskRepeatPreset == 'weekly'){\n        return (newTask || (Math.abs(genDate.diff(taskDate,'days')) >= 7));\n      }\n    } else if(task.taskRepeatCustom && task.taskRepeatCustom != 0) {\n      return (newTask || (Math.abs(genDate.diff(taskDate,'days')) >= task.taskRepeatCustom));\n    } else if(task.taskRepeatDays.length) {\n      var day = genDate.day();\n      return (task.taskRepeatDays.indexOf(day) > -1);\n    }\n  })\n  callback(null, filteredTasks)\n}\n\nfunction generateTasks(genDate, tasks,callback) {\n  var newGenTaskPromises = tasks.map(function(task) {\n    var newTask = _.pick(task, pickTaskDetails);\n    newTask.occurrenceDate = dateUtil.standardizeDate(genDate);\n    var newTaskObj = new TimelineTask(newTask);\n    if(task.childTasks && task.childTasks.length) {\n      return buildParentTask(newTaskObj, task);\n    } else if(!task.isChildTask){\n      return newTaskObj.save();\n    } else {\n      console.log('child task', task);\n    }\n  })\n\n  Q.all(newGenTaskPromises)\n    .then(newTasks => {\n      callback(null, {\n        newTasks : newTasks,\n        templateTasks : tasks\n      })\n    })\n    .catch(callback)\n}\n\nfunction buildParentTask(newParentTask, taskTemplate) {\n  var deferred = Q.defer();\n  async.waterfall([\n    async.apply(retrieveChildren, taskTemplate.childTasks),\n    async.apply(buildChildren, newParentTask),\n    async.apply(saveChildrenToParent, newParentTask)\n  ], function(err, results) {\n    if(err) deferred.reject(err);\n    else {\n      deferred.resolve(results);\n    }\n  })\n  return deferred.promise;\n}\n\nfunction retrieveChildren(childIds, callback) {\n  TimelineTask.find({\n    '_id' : {$in : childIds}\n  })\n    .exec(function(err, children) {\n      if(err) return callback(err);\n      else return callback(null, children);\n    })\n}\n\nfunction buildChildren(parentTask, childrenTasks, callback) {\n  var childPromises = childrenTasks.map(function(childTaskTemplate) {\n    var newTask = _.pick(childTaskTemplate, pickTaskDetails);\n    newTask.parentTask = parentTask._id;\n    newTask.site = parentTask.site;\n    newTask.occurrenceDate = parentTask.occurrenceDate;\n    newTask.room = parentTask.room;\n    newTask.childIndex = childTaskTemplate.childIndex;\n\n    var newTaskObj = new TimelineTask(newTask);\n    return newTaskObj.save();\n  })\n\n  Q.all(childPromises)\n    .then(newTasks => {\n      var childIds = newTasks.map(function(child) {\n        return child._id;\n      })\n      callback(null, childIds)\n    })\n    .catch(callback)\n}\n\nfunction saveChildrenToParent(parentTask, childTaskIds, callback) {\n  parentTask.childTasks = childTaskIds;\n  parentTask.save(function(err) {\n    if(err) callback(err);\n    else callback(null, parentTask);\n  })\n}\n\nfunction updateTemplateTasks(genDate, allTasks, callback) {\n  var taskTemplateIds = allTasks.templateTasks.map(function(task) {\n    return task._id\n  })\n  var standardDate = dateUtil.standardizeDate(genDate);\n  TimelineTask.update({_id : {$in : taskTemplateIds}},\n    {$set: {taskLastBuilt : standardDate}},\n    {multi : true, new: true},\n    function(err, updated) {\n      callback(null, {\n        updated : updated,\n        newTasks : allTasks.newTasks\n      })\n    })\n}\n\n\nexports.buildRoomTasks = function(req,res) {\n\n  var tlDetails = req.body;\n  tlDetails.flippedTBD = false;\n  var TBDTaskCount = 0;\n  var reoccuringTaskCount = 0;\n  var tlDates = tlDetails.tlDates;\n  var roomLengths = findLengths(tlDates.startDate, tlDates.flippedDate, tlDates.endDate);\n  if(!tlDates.flippedDate) {\n    tlDetails.flippedTBD = true;\n  }\n  var isStandardVegLength = (roomLengths.vegLength == masterPeriods['veg'].periodLength),\n    isStandardFlowerLength = (roomLengths.vegLength == masterPeriods['flower'].periodLength);\n\n  TimelineTask.find(\n    {isMaster : true}\n  )\n    .exec(function(err, masterTasks) {\n      if(err) return res.status(400).json(err);\n      else {\n        if(masterTasks.length) {\n          buildTimelineTasks(masterTasks)\n        } else {\n          return res.status(300).json({});\n        }\n      }\n    })\n\n\n  // Create new room tasks from the master tasks\n  function buildTimelineTasks(masterTasks) {\n    var tlTasksPromises = masterTasks.map(masterTask => {\n      if(masterTask.taskType == 'x-check' || masterTask.taskType == 'dailyCheck') {\n        reoccuringTaskCount++;\n      } else if(masterTask.occurrenceObj && masterTask.occurrenceObj.type == 'flower' && tlDetails.flippedTBD) {\n        TBDTaskCount++;\n      }\n      return buildTask(masterTask, roomLengths.vegLength, roomLengths.flowerLength, isStandardVegLength, isStandardFlowerLength, tlDetails)\n    })\n\n    Q.all(tlTasksPromises)\n      .then(newTasks => {\n        return res.status(200).json({\n          newTasks : newTasks,\n          reoccurringTaskCount : reoccuringTaskCount,\n          TBDTaskCount : TBDTaskCount\n        });\n      })\n      .catch(err => {\n        return res.status(420).json(err);\n      })\n  }\n\n}\n\nexports.buildCycleTasks = function(req,res) {\n\n  var inPeriod = req.body.inPeriod;\n  var room = req.body.room;\n  var fromDate = req.body.fromDate;\n\n  TimelineTask.find(\n    {isMaster : true, taskType : 'tunnel-timeline', inPeriod : inPeriod}\n    )\n    .exec(function(err, masterTasks) {\n      if(err) return res.status(400).json(err);\n      else {\n        if(masterTasks.length) {\n          buildCycleTasks(masterTasks)\n        } else {\n          return res.status(300).json({});\n        }\n      }\n    })\n\n  // Create new room tasks from the master tasks\n  function buildCycleTasks(masterTasks) {\n    var tasksPromises = masterTasks.map(masterTask => {\n      return buildCycleTask(masterTask, room, fromDate)\n    })\n\n    var roomGeneratedField;\n    var today = dateUtil.standardizeDate(new Date());\n    if(inPeriod === 'veg') {\n      roomGeneratedField = 'generatedVegTasks';\n    } else {\n      roomGeneratedField = 'generatedFlowerTasks';\n    }\n    Q.all(tasksPromises)\n      .then(newTasks => {\n        Room.findById(room._id).exec(function(err, room) {\n          room[roomGeneratedField] = today;\n          room.save();\n        });\n        return res.status(200).json(newTasks);\n      })\n      .catch(err => {\n        return res.status(420).json(err);\n      })\n  }\n}\nexports.generateTasksFromTimeline = function(req,res) {\n  var room = req.body.room;\n  var tlTemplateId = req.body.tlTemplateId;\n  var fromDate = dateUtil.standardizeDate(req.body.fromDate);\n  var fromDateType = req.body.fromDateType;\n\n  TimelineTask.find(\n    {isMaster : true,\n      taskType : 'tunnel-timeline',\n      taskTLTemplate : tlTemplateId\n    }\n  )\n    .exec(function(err, tlTasks) {\n      if(err) return res.status(400).json(err);\n      else {\n        if(tlTasks.length) {\n          buildCycleTasks(tlTasks)\n        } else {\n          return res.status(300).json({});\n        }\n      }\n    })\n\n  // Create new room tasks from the master tasks\n  function buildCycleTasks(tasksToGen) {\n    var newTasks = _.map(tasksToGen, function(t) {\n      return buildCycleTaskFromTemplate(t, room, fromDate);\n    })\n\n    var buildErrors = [];\n\n    _.forEach(newTasks, function(t) {\n      if(t.genError) {\n        buildErrors.push(t);\n      }\n    })\n\n    if(buildErrors.length > 0) {\n      return res.status(420).json({\n        buildErrors : buildErrors\n      });\n    } else {\n      var taskPromises = _.map(newTasks, function(newTaskInfo) {\n        if(newTaskInfo.templateTask.childTasks && newTaskInfo.templateTask.childTasks.length > 0) {\n          return buildParentTask(newTaskInfo.builtTask, newTaskInfo.templateTask);\n        } else {\n          if(newTaskInfo && newTaskInfo.builtTask) {\n            return newTaskInfo.builtTask.save()\n          }\n        }\n      })\n\n      var newTaskGenerationEvent = {\n        generatedDate : new Date(),\n        fromTLTemplateId : tlTemplateId,\n        fromDateType : fromDateType\n      }\n      Q.all(taskPromises)\n        .then(generatedTasks => {\n          Room.findById(room._id).exec(function(err, room) {\n            room.taskGenerationEvents.push(newTaskGenerationEvent);\n            room.markModified('taskGenerationEvents');\n            room.save();\n            var returnData = {\n              newTasks : generatedTasks,\n              taskGenerationEvents : room.taskGenerationEvents\n            }\n            return res.status(200).json(returnData);\n          });\n        })\n        .catch(err => {\n          return res.status(420).json(err);\n        })\n    }\n  }\n}\n\nfunction newTask(task, roomDetails) {\n  var newTaskObj = new TimelineTask(task);\n  newTaskObj.forCycleStarting = roomDetails.startDate;\n  newTaskObj.room = roomDetails._id;\n  newTaskObj.site = roomDetails.site;\n  return newTaskObj.save();\n}\n\nfunction findLengths(startDate, flippedDate, endDate) {\n  var vegLength,\n    flowerLength;\n\n  if(!flippedDate) {\n    vegLength = 21,\n      flowerLength = 56;\n  } else {\n    vegLength = moment(flippedDate).diff(moment(startDate), 'days'),\n      flowerLength = moment(endDate).diff(moment(flippedDate), 'days');\n  }\n\n  return {\n    vegLength : vegLength,\n    flowerLength : flowerLength\n  }\n}\n\nfunction findDayWeekPeriodFromDate(vegLength, roomStart, roomFlipped, taskDate) {\n  var inPeriod,\n    startDate = moment(roomStart),\n    flippedDate;\n\n  if(!roomFlipped) {\n    flippedDate = moment(startDate).add(3,'weeks');\n  } else {\n    flippedDate = moment(roomFlipped);\n  }\n  var taskDay = moment(taskDate).diff(startDate, 'days');\n  if(taskDay > vegLength ) {\n    inPeriod = 'flower';\n    taskDay = moment(taskDate).diff(flippedDate, 'days');\n  } else {\n    inPeriod = 'veg';\n  }\n  taskDay += 1;\n  var dayAndWeek = findDayAndWeek(taskDay);\n  return {\n    inPeriod : inPeriod,\n    taskDay : dayAndWeek.day,\n    taskWeek : dayAndWeek.week\n  }\n\n}\n\n\nfunction buildTask(masterTask, vegLength, flowerLength, isStandardVeg, isStandardFlower, tlDetails) {\n  var occurrenceObj = masterTask.occurrenceObj,\n    occurrenceDay,\n    dayAndWeek;\n  var newTaskObj = new TimelineTask({\n    title : masterTask.title,\n    backgroundColor : masterTask.backgroundColor,\n    warningColor : masterTask.warningColor,\n    timeEstimate : masterTask.timeEstimate,\n    notes : masterTask.notes,\n    forCycleStarting : tlDetails.tlDates.startDate,\n    priority : masterTask.priority,\n    subPriority : masterTask.subPriority,\n    taskRepeatCustom : masterTask.taskRepeatCustom,\n    taskRepeatPreset : masterTask.taskRepeatPreset,\n    room : tlDetails.room,\n    site : tlDetails.site,\n    inPeriod : '',\n    isMaster : false,\n    taskType : masterTask.taskType,\n  })\n\n  if(masterTask.taskType === 'daily-check' || masterTask.taskType === 'x-check') {\n    newTaskObj.checkTemplateObj = true;\n    newTaskObj.saveToSite = true;\n    newTaskObj.taskRepeatCustom = masterTask.taskRepeatCustom;\n    newTaskObj.taskRepeatPreset = masterTask.taskRepeatPreset;\n    newTaskObj.templateId = masterTask._id;\n    newTaskObj.masterCheckLocation = masterTask.masterCheckLocation;\n  } else {\n    delete newTaskObj.saveToSite;\n    if(occurrenceObj.type === 'flower' && tlDetails.flippedTBD) {\n      newTaskObj.saveToRoomTBD = true;\n    } else {\n      var periodLength,\n        isStandardPeriod = false;\n      if(occurrenceObj.type == 'veg') {\n        periodLength = vegLength;\n        newTaskObj.inPeriod = 'veg';\n        isStandardPeriod = isStandardVeg;\n      }\n      else if(occurrenceObj.type == 'flower') {\n        periodLength = flowerLength;\n        newTaskObj.inPeriod = 'flower';\n        isStandardPeriod = isStandardFlower;\n      } else return;\n\n      if(occurrenceObj.occurrenceDay.type == 'percent' && !isStandardPeriod) {\n        occurrenceDay = calculateDayFromMasterPercent(occurrenceObj.occurrenceDay.value, occurrenceObj.type, periodLength);\n      } else {\n        occurrenceDay = occurrenceObj.occurrenceDay.value;\n      }\n\n      dayAndWeek = findDayAndWeek(occurrenceDay),\n        newTaskObj.taskDay = dayAndWeek.day,\n        newTaskObj.taskWeek = dayAndWeek.week,\n        newTaskObj.occurrenceDate = findTaskDate(newTaskObj, tlDetails.tlDates.startDate, tlDetails.tlDates.flippedDate);\n    }\n  }\n\n\n  var deferred;\n  if(newTaskObj.saveToSite) {\n    deferred = Q.defer();\n    SiteCtrl.shouldImportToSite(newTaskObj.site, newTaskObj)\n      .then(function() {\n        newTaskObj.masterCheckLocation = null;\n        newTaskObj.save(function(err) {\n          if(err) deferred.reject(err);\n          else {\n            SiteCtrl.newReoccurringTask(newTaskObj)\n              .then(function(response) {\n                deferred.resolve(newTaskObj);\n              })\n              .catch(function(err) {\n                deferred.reject(err);\n              })\n          }\n        })\n      })\n\n    .catch(function() {\n      deferred.resolve();\n    })\n\n    return deferred.promise;\n  } else if(newTaskObj.saveToRoomTBD) {\n    deferred = Q.defer();\n    Room.findByIdAndUpdate(newTaskObj.room, {$push : {TBDTasks : newTaskObj}}, {'new' : true})\n      .exec(function(err, room) {\n        if(err) {\n          deferred.reject(err);\n        } else {\n          deferred.resolve(newTaskObj)\n        }\n      })\n\n    return deferred.promise;\n  } else {\n    return newTaskObj.save();\n  }\n}\n\nfunction buildCycleTaskFromTemplate(templateTask, room, fromDate) {\n  var occurrenceObj = templateTask.occurrenceObj,\n    occurrenceDay,\n    dayAndWeek;\n  var genError;\n  var newTaskObj = new TimelineTask({\n    title : templateTask.title,\n    backgroundColor : templateTask.backgroundColor,\n    warningColor : templateTask.warningColor,\n    timeEstimate : templateTask.timeEstimate,\n    notes : templateTask.notes,\n    forCycleStarting : room.startDate,\n    priority : templateTask.priority,\n    subPriority : templateTask.subPriority,\n    taskRepeatCustom : templateTask.taskRepeatCustom,\n    taskRepeatPreset : templateTask.taskRepeatPreset,\n    taskRepeatDays : templateTask.taskRepeatDays,\n    images : templateTask.images,\n    room : room,\n    site : room.siteId,\n    inPeriod : templateTask.inPeriod,\n    isMaster : false,\n    taskType : templateTask.taskType,\n    fromTLTemplate : templateTask.taskTLTemplate,\n    masterTaskId : templateTask._id\n  })\n\n  try {\n    occurrenceDay = occurrenceObj.occurrenceDay.value;\n  } catch(e) {\n    genError = {\n      genTitle : \"Could not determine what day this task occurs.\",\n      solution : \"Check the master task and ensure all fields under 'Master Occurrence' have a value.\",\n      taskTitle : templateTask.title\n    }\n  }\n  if(templateTask.inPeriod === 'na' || templateTask.inPeriod === 'finalize') {\n    try {\n      newTaskObj.taskDay = templateTask.occurrenceInfo.selectedTime.day,\n        newTaskObj.taskWeek = templateTask.occurrenceInfo.selectedTime.week,\n        newTaskObj.occurrenceDate = dateUtil.standardizeDate(findTaskDateFromGeneralDate(newTaskObj, fromDate));\n    } catch(e) {\n      if(!templateTask.occurrenceInfo || !templateTask.occurrenceInfo.selectedTime) {\n        genError = {\n          genTitle : \"Could not determine when the task should occur, i.e., 'W1-V', 'W3-F'.\",\n          solution : \"Edit the master task and make sure all fields under 'Master Occurrence' have a value.\",\n          taskTitle : templateTask.title\n        }\n      } else {\n        genError = {\n          genTitle : \"Unknown error occurred.\",\n          solution : \"Check the master task and ensure all fields under 'Master Occurrence' have a value.\",\n          taskTitle : templateTask.title\n        }\n      }\n    }\n  } else {\n    dayAndWeek = findDayAndWeek(occurrenceDay),\n      newTaskObj.taskDay = dayAndWeek.day,\n      newTaskObj.taskWeek = dayAndWeek.week,\n      newTaskObj.occurrenceDate = dateUtil.standardizeDate(findTaskDateFromGeneralDate(newTaskObj, fromDate));\n  }\n\n  return {\n    genError : genError,\n    builtTask : newTaskObj,\n    templateTask : templateTask\n  }\n\n  // if(templateTask.childTasks && templateTask.childTasks.length) {\n  //   return buildParentTask(newTaskObj, templateTask)\n  // } else return newTaskObj.save();\n\n}\n\nfunction buildCycleTask(masterTask, room, fromDate) {\n  var occurrenceObj = masterTask.occurrenceObj,\n    occurrenceDay,\n    dayAndWeek;\n  var newTaskObj = new TimelineTask({\n    title : masterTask.title,\n    backgroundColor : masterTask.backgroundColor,\n    warningColor : masterTask.warningColor,\n    timeEstimate : masterTask.timeEstimate,\n    notes : masterTask.notes,\n    forCycleStarting : room.startDate,\n    priority : masterTask.priority,\n    subPriority : masterTask.subPriority,\n    taskRepeatCustom : masterTask.taskRepeatCustom,\n    taskRepeatPreset : masterTask.taskRepeatPreset,\n    room : room,\n    site : room.siteId,\n    inPeriod : masterTask.inPeriod,\n    isMaster : false,\n    taskType : masterTask.taskType\n  })\n\n  occurrenceDay = occurrenceObj.occurrenceDay.value;\n\n  dayAndWeek = findDayAndWeek(occurrenceDay),\n    newTaskObj.taskDay = dayAndWeek.day,\n    newTaskObj.taskWeek = dayAndWeek.week,\n    newTaskObj.occurrenceDate = dateUtil.standardizeDate(findTaskDateFromGeneralDate(newTaskObj, fromDate));\n\n  if(masterTask.childTasks && masterTask.childTasks.length) {\n    return buildParentTask(newTaskObj, masterTask)\n  } else return newTaskObj.save();\n\n}\n\nfunction calculateDayFromMasterPercent(masterDay, period, periodLength) {\n  var masterPeriodLength = masterPeriods[period].periodLength,\n    percentThroughMasterPeriod = masterDay/masterPeriodLength;\n  return Math.ceil(percentThroughMasterPeriod * periodLength);\n}\n\nfunction findDayAndWeek(day) {\n  var dayAndWeek = {\n    day : null,\n    week : null\n  }\n  if(day > 7) {\n    dayAndWeek.week = Math.ceil(day / 7);\n    dayAndWeek.day = Math.round(day % 7);\n    if(!dayAndWeek.day) {\n      dayAndWeek.day = 7;\n    }\n  } else {\n    dayAndWeek = {\n      day : day,\n      week : 1\n    }\n  }\n\n  return dayAndWeek;\n}\n\nfunction findTaskDate(task, startDate, flippedDate) {\n  var weekMultiplier = task.taskWeek -1;\n  var dayInPeriod = (weekMultiplier*7) + (task.taskDay-1);\n  var periodStartDate,\n    taskDate;\n  if(task.inPeriod === 'flower' && !flippedDate) {\n    periodStartDate = moment(startDate).add(3, 'weeks');\n  } else if(task.inPeriod == 'flower' && flippedDate) {\n    periodStartDate = moment(flippedDate);\n  } else periodStartDate = moment(startDate);\n\n\n  taskDate = periodStartDate.add(dayInPeriod, 'days');\n  return taskDate;\n}\n\nfunction findTaskDateFromGeneralDate(task,fromDate) {\n  var weekMultiplier = task.taskWeek -1;\n  var dayInPeriod = (weekMultiplier*7) + (task.taskDay-1);\n  var startDate = moment(fromDate);\n  return startDate.add(dayInPeriod, 'days');;\n}\n"]}